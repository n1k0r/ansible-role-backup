#!/usr/bin/env bash

function rclone_auth {
    rclone \
{% for arg in backup.target.args %}
        --{{ arg }}={{ backup.target.args[arg] }} \
{% endfor %}
        $@
}

function filename {
    echo :{{ backup.target.type }}:{{ backup.target.prefix }}$(hostname)/$1/$(date -Iseconds --utc)
}

function rcat {
    tar $3 -cf - $1 | \
    rclone_auth rcat \
        --progress \
        $(filename $2)$4
}

function send {
    rcat $1 $2 "" .tar
}

function send_arch {
    rcat $1 $2 -z .tgz
}

function clear {
    rclone_auth delete --min-age $2 :{{ backup.target.type }}:{{ backup.target.prefix }}$(hostname)/$1
    rclone_auth rmdir --min-age $2 :{{ backup.target.type }}:{{ backup.target.prefix }}$(hostname)/$1
}

{% for dir in backup.dirs %}
clear {{ dir.dest }} {{ dir.max_age }}

{% if "compress" in dir and dir.compress %}
send_arch {{ dir.src }} {{ dir.dest }}
{% else %}
send {{ dir.src }} {{ dir.dest }}
{% endif %}

{% endfor %}
